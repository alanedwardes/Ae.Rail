<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Train Information</title>
	<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
	<div class="header">
		<a href="#" id="homeLink" class="title">Train Information</a>
	</div>
	<div id="search" class="search-panels">
		<!-- Station Search Panel -->
		<div class="panel">
			<h2 class="panel-title">Station Departures & Arrivals</h2>
			<div class="search-box">
				<input id="sq" class="search-input" type="text" placeholder="Try 'Paddington' or 'PAD'">
				<div id="sDropdown" class="dropdown" style="display:none;"></div>
			</div>
			<div class="hint">Search for live departure and arrival boards from National Rail. Type a station name or CRS code.</div>
		</div>
		<!-- Service Search Panel -->
		<div class="panel">
			<h2 class="panel-title">Service Search</h2>
			<div class="search-box">
				<input id="q" class="search-input" type="text" placeholder="Try 'Kings Cross to Leeds' or '1D31'">
				<div id="dropdown" class="dropdown" style="display:none;"></div>
			</div>
			<div class="hint">Use origin 'to' destination, or type an Operational Train Number (you can find these when selecting a train on <a href="https://map.signalbox.io/">map.signalbox.io</a>).</div>
		</div>
		<!-- Vehicle Search Panel -->
		<div class="panel">
			<h2 class="panel-title">Vehicle Search</h2>
			<div class="search-box">
				<input id="vq" class="search-input" type="text" placeholder="Try a Vehicle ID like '91111'">
				<div id="vDropdown" class="dropdown" style="display:none;"></div>
			</div>
			<div class="hint">Search for a specific railway vehicle by its identification number.</div>
			<div id="vresult" class="section"></div>
		</div>
	</div>
	<div id="station" class="panel" style="display:none;">
		<div class="section" style="display:flex; justify-content:space-between; align-items:center;">
			<h3 style="margin:0;"><span id="stationName"></span> (<span id="stationCrs" class="mono"></span>)</h3>
			<a id="stationBackBtn" href="#" class="muted" style="font-size:13px;">← Back to search</a>
		</div>
		<div id="stationMessages" class="section" style="display:none;"></div>
		<div class="section">
			<div id="stationServices" class="list"></div>
		</div>
	</div>
	<div id="svc" class="panel" style="display:none;">
		<div class="section" style="display:flex; justify-content:space-between; align-items:center;">
			<h3 style="margin:0;">Service</h3>
			<a id="backBtn" href="#" class="muted" style="font-size:13px;">← Back to search</a>
		</div>
	<div class="section">
		<div class="kv">
			<div class="muted">Operational Train Number</div><div id="otn" class="mono"></div>
			<div class="muted">Service Date</div><div id="svcdate"></div>
			<div class="muted">Origin STD</div><div id="std"></div>
			<div class="muted">Origin</div><div id="origin" class="station-link-container"></div>
			<div class="muted">Destination</div><div id="dest" class="station-link-container"></div>
			<div class="muted">Class</div><div id="classCode"></div>
			<div class="muted">Type</div><div id="classes"></div>
			<div class="muted">Power</div><div id="power"></div>
		</div>
	</div>
		<div class="section" id="wikiSection" style="display:none;">
			<h3>Class information</h3>
			<div id="wikiContent" class="card wiki-card"></div>
		</div>
		<div class="section" id="realtimeSection" style="display:none;">
			<h3>Real-time service</h3>
			<div id="realtimeContent" class="list"></div>
		</div>
		<div class="section">
			<h3>Vehicles</h3>
			<div id="vehicles" class="list"></div>
		</div>
	</div>
	<div class="disclaimer">
		Data is sourced from <a href="https://raildata.org.uk/" target="_blank" rel="noopener noreferrer">raildata.org.uk</a>. This is not an official website.
	</div>
</div>

<script>
const API_BASE = window.location.origin;

const q = document.getElementById('q');
const dropdown = document.getElementById('dropdown');
const vq = document.getElementById('vq');
const vDropdown = document.getElementById('vDropdown');
const sq = document.getElementById('sq');
const sDropdown = document.getElementById('sDropdown');
const vresult = document.getElementById('vresult');
const searchPanel = document.getElementById('search');
const svcPanel = document.getElementById('svc');
const stationPanel = document.getElementById('station');
const backBtn = document.getElementById('backBtn');
const stationBackBtn = document.getElementById('stationBackBtn');
const homeLink = document.getElementById('homeLink');
const wikiSection = document.getElementById('wikiSection');
const wikiContent = document.getElementById('wikiContent');
const realtimeSection = document.getElementById('realtimeSection');
const realtimeContent = document.getElementById('realtimeContent');
let abortCtrl = null;
let timer = null;
let wikiRequestToken = 0;

function escapeHtml(value) {
	if (value == null) return '';
	return value
		.toString()
		.replace(/&/g, '&amp;')
		.replace(/</g, '&lt;')
		.replace(/>/g, '&gt;')
		.replace(/"/g, '&quot;')
		.replace(/'/g, '&#39;');
}

function safeHttpUrl(url) {
	if (!url || typeof url !== 'string') return '';
	if (!/^https?:\/\//i.test(url)) return '';
	return url;
}

function renderItems(items) {
	if (!items || items.length === 0) {
		dropdown.style.display = 'none';
		dropdown.innerHTML = '';
		return;
	}
	dropdown.innerHTML = items.map(it => {
		const fromLink = createStationLink(it.origin);
		const toLink = createStationLink(it.destination);
		const staVal = it.sta;
		const sta = staVal ? `, STA ${staVal}` : '';
		const otn = it.operationalTrainNumber || '';
		const svcDate = it.serviceDate || '';
		const std = it.originStd || '';
		return `
			<div class="item" data-otn="${otn}" data-date="${svcDate}" data-std="${std}">
				<div class="line-1">
					<span class="otn">${otn}</span>
					<span class="date">${svcDate}</span>
					<span class="pill">${std}${sta}</span>
				</div>
				<div class="line-2">${fromLink} → ${toLink}</div>
			</div>`;
	}).join('');
	dropdown.style.display = 'block';

	Array.from(dropdown.querySelectorAll('.item')).forEach(el => {
		el.addEventListener('click', (e) => {
			// Check if clicked on a station link
			if (e.target.classList.contains('station-link')) {
				e.stopPropagation();
				const url = new URL(e.target.href);
				const crs = url.searchParams.get('station');
				if (crs) {
					e.preventDefault();
					showStation(crs);
				}
				return;
			}
			
			const otn = el.getAttribute('data-otn');
			const date = el.getAttribute('data-date');
			const std = el.getAttribute('data-std');
			showService(otn, date, std);
		});
	});
}

async function search(qs) {
	if (abortCtrl) abortCtrl.abort();
	abortCtrl = new AbortController();
	const url = `${API_BASE}/api/v1/trains/autocomplete?q=${encodeURIComponent(qs)}&limit=10`;
	try {
		const res = await fetch(url, { signal: abortCtrl.signal });
		if (!res.ok) throw new Error('HTTP ' + res.status);
		const data = await res.json();
		renderItems(data);
	} catch (e) {
		if (e.name !== 'AbortError') {
			console.error(e);
			renderItems([]);
		}
	}
}

function renderVehicleItems(items) {
	if (!items || items.length === 0) {
		vDropdown.style.display = 'none';
		vDropdown.innerHTML = '';
		return;
	}
	vDropdown.innerHTML = items.map(v => {
		const vehId = v.vehicleId || '';
		const cls = v.classCode ? `Class ${v.classCode}` : '';
		const typ = v.typeOfVehicle || '';
		return `
			<div class="item" data-veh="${vehId}">
				<div class="line-1">
					<span class="otn">${vehId}</span>
					<span class="date">${cls}</span>
				</div>
				<div class="line-2">${typ}</div>
			</div>`;
	}).join('');
	vDropdown.style.display = 'block';
	Array.from(vDropdown.querySelectorAll('.item')).forEach(el => {
		el.addEventListener('click', () => {
			const vehId = el.getAttribute('data-veh');
			showVehicle(vehId);
			vDropdown.style.display = 'none';
		});
	});
}

async function searchVehicles(qs) {
	if (abortCtrl) abortCtrl.abort();
	abortCtrl = new AbortController();
	const url = `${API_BASE}/api/v1/trains/vehicles/autocomplete?q=${encodeURIComponent(qs)}&limit=10`;
	try {
		const res = await fetch(url, { signal: abortCtrl.signal });
		if (!res.ok) throw new Error('HTTP ' + res.status);
		const data = await res.json();
		renderVehicleItems(data);
	} catch (e) {
		if (e.name !== 'AbortError') {
			console.error(e);
			renderVehicleItems([]);
		}
	}
}

function setText(id, val) {
	document.getElementById(id).textContent = val || '';
}

function fmtPlace(name, tiploc) {
	if (name && tiploc && name !== tiploc) return `${name} (${tiploc})`;
	return name || tiploc || '';
}

function createStationLink(station, textOnly = false) {
	if (!station) return '';
	const name = station.nlcDesc || station.tiploc || '';
	const crs = station.threeAlpha || '';
	const displayText = fmtPlace(name, crs);
	
	if (!displayText) return '';
	if (!crs || textOnly) return displayText;
	
	return `<a href="?station=${encodeURIComponent(crs)}" class="station-link">${displayText}</a>`;
}

function attachStationLinkHandlers(container) {
	Array.from(container.querySelectorAll('.station-link')).forEach(link => {
		link.addEventListener('click', (e) => {
			e.preventDefault();
			const url = new URL(link.href);
			const crs = url.searchParams.get('station');
			if (crs) {
				showStation(crs);
			}
		});
	});
}

function vehicleCardHtml(v, options = {}) {
	const {
		showResourcePosition = false,
		linkVehicle = false
	} = options;
	const vehId = v.vehicleId || '(unknown vehicle)';
	const rpVal = v.resourcePosition;
	const rp = showResourcePosition && rpVal != null && rpVal !== '' ? `#${rpVal} ` : '';
	const clsVal = v.classCode;
	const cls = clsVal ? ` Class ${clsVal}` : '';
	const typeVal = v.typeOfVehicle;
	const type = typeVal ? ` • Type ${typeVal}` : '';
	const specType = v.specificType || '';
	const maxSpeed = v.maximumSpeed || '';
	let seats = v.numberOfSeats;
	seats = seats == null ? '' : seats;
	const weight = v.weight || '';
	const brake = v.trainBrakeType || '';
	const livery = v.livery || '';
	const decor = v.decor || '';
	const power = v.powerType || '';
	const driv = v.isDrivingVehicle == null ? '' : (v.isDrivingVehicle ? 'Yes' : 'No');
	const vehLabel = linkVehicle
		? `<a class="vehicle-link mono" href="?veh=${encodeURIComponent(vehId)}">${vehId}</a>`
		: vehId;
	return `<div class="card">
		<div><strong>${rp}${vehLabel}</strong><span class="muted">${cls}${type}</span></div>
		<div class="muted">${specType}</div>
		<div class="kv" style="margin-top:6px;">
			<div>Max Speed</div><div>${maxSpeed}</div>
			<div>Seats</div><div>${seats}</div>
			<div>Weight</div><div>${weight}</div>
			<div>Brake</div><div>${brake}</div>
			<div>Livery</div><div>${livery}</div>
			<div>Decor</div><div>${decor}</div>
			<div>Power</div><div>${power}</div>
			<div>Driving Vehicle</div><div>${driv}</div>
		</div>
	</div>`;
}

function renderVehicleDetails(v) {
	if (!v) {
		vresult.innerHTML = '';
		return;
	}
	const cardHtml = vehicleCardHtml(v);
	vresult.innerHTML = `
		${cardHtml}
		<div class="section">
			<h3>Recent services</h3>
			<div id="vusage" class="list"><div class="muted">Loading…</div></div>
		</div>
	`;
	loadVehicleUsage(v.vehicleId).then(items => {
		renderVehicleUsage(items || []);
	}).catch(() => {
		const el = document.getElementById('vusage');
		if (el) el.innerHTML = '<div class="muted">Failed to load recent services.</div>';
	});
}

async function loadWikipediaClass(classCode) {
	const url = `${API_BASE}/api/v1/wiki/british-rail-class?class=${encodeURIComponent(classCode)}`;
	const res = await fetch(url);
	if (res.status === 404) return null;
	if (!res.ok) throw new Error('Wikipedia load failed');
	return await res.json();
}

function truncateText(text, maxLength = 420) {
	if (!text) return '';
	return text.length > maxLength ? `${text.slice(0, maxLength).trim()}…` : text;
}

function renderWikipediaInfo(info) {
	if (!wikiContent) return;
	if (!info) {
		wikiContent.innerHTML = '<div class="muted">No Wikipedia information found for this class.</div>';
		return;
	}

	const title = escapeHtml(info.displayTitle || info.title || '');
	const description = escapeHtml(info.description || '');
	const extract = escapeHtml(truncateText(info.extract || info.description || ''));
	const pageUrl = safeHttpUrl(info.pageUrl);
	const thumbnailUrl = safeHttpUrl(info.thumbnailUrl);
	const alt = escapeHtml(title ? `${title} photo` : 'Class thumbnail');

	const infoboxRows = Array.isArray(info.infobox)
		? info.infobox
			.filter(f => f && f.label && f.value)
			.slice(0, 8)
			.map(f => `
				<div class="wiki-grid-row">
					<div class="muted">${escapeHtml(f.label)}</div>
					<div>${escapeHtml(f.value)}</div>
				</div>`)
			.join('')
		: '';

	wikiContent.innerHTML = `
		<div class="wiki-header">
			${thumbnailUrl ? `<div class="wiki-thumb"><img src="${thumbnailUrl}" alt="${alt}"></div>` : ''}
			<div>
				${title ? `<div class="wiki-title">${title}</div>` : ''}
				${description ? `<div class="wiki-description muted">${description}</div>` : ''}
				${extract ? `<p class="wiki-extract">${extract}</p>` : ''}
				${pageUrl ? `<a class="wiki-link" href="${pageUrl}" target="_blank" rel="noopener noreferrer">View on Wikipedia →</a>` : ''}
			</div>
		</div>
		${infoboxRows ? `<div class="wiki-grid">${infoboxRows}</div>` : ''}
	`;
}

function hideWikipediaSection() {
	if (!wikiSection || !wikiContent) return;
	wikiSection.style.display = 'none';
	wikiContent.innerHTML = '';
	wikiRequestToken += 1;
}

function hideRealTimeSection() {
	if (!realtimeSection || !realtimeContent) return;
	realtimeSection.style.display = 'none';
	realtimeContent.innerHTML = '';
}

async function updateWikipediaPanel(classCode) {
	if (!wikiSection || !wikiContent) return;
	if (!classCode) {
		hideWikipediaSection();
		return;
	}

	wikiRequestToken += 1;
	const token = wikiRequestToken;
	wikiSection.style.display = 'block';
	wikiContent.innerHTML = '<div class="muted">Loading class information…</div>';

	try {
		const info = await loadWikipediaClass(classCode);
		if (token !== wikiRequestToken) return;
		renderWikipediaInfo(info);
	} catch (e) {
		if (token !== wikiRequestToken) return;
		console.error(e);
		wikiContent.innerHTML = '<div class="muted">Failed to load Wikipedia information.</div>';
	}
}

async function loadVehicleById(vehId) {
	const url = `${API_BASE}/api/v1/trains/vehicles/by-id?VehicleId=${encodeURIComponent(vehId)}`;
	const res = await fetch(url);
	if (!res.ok) throw new Error('Vehicle load failed');
	return await res.json();
}

async function loadVehicleUsage(vehId) {
	const url = `${API_BASE}/api/v1/trains/vehicle-usage?VehicleId=${encodeURIComponent(vehId)}&limit=10`;
	const res = await fetch(url);
	if (!res.ok) throw new Error('Usage load failed');
	return await res.json();
}

async function showVehicle(vehId, push = true) {
	searchPanel.style.display = 'grid';
	svcPanel.style.display = 'none';
	dropdown.style.display = 'none';
	hideRealTimeSection();
	if (push) {
		const qs = `?veh=${encodeURIComponent(vehId)}`;
		history.pushState({ veh: vehId }, '', `${qs}`);
	}
	vresult.innerHTML = '<div class="muted">Loading…</div>';
	try {
		const v = await loadVehicleById(vehId);
		renderVehicleDetails(v);
	} catch (e) {
		console.error(e);
		vresult.innerHTML = '<div class="muted">Failed to load vehicle.</div>';
	}
}

function renderVehicleUsage(items) {
	const el = document.getElementById('vusage');
	if (!el) return;
	if (!items || items.length === 0) {
		el.innerHTML = '<div class="muted">No recent services found.</div>';
		return;
	}
	el.innerHTML = items.map(it => {
		const fromLink = createStationLink(it.origin);
		const toLink = createStationLink(it.destination);
		const staVal = it.sta;
		const sta = staVal ? `, STA ${staVal}` : '';
		const otn = it.operationalTrainNumber || '';
		const svcDate = it.serviceDate || '';
		const std = it.originStd || '';
		return `
			<div class="item" data-otn="${otn}" data-date="${svcDate}" data-std="${std}">
				<div class="line-1">
					<span class="otn">${otn}</span>
					<span class="date">${svcDate}</span>
					<span class="pill">${std}${sta}</span>
				</div>
				<div class="line-2">${fromLink} → ${toLink}</div>
			</div>`;
	}).join('');
	Array.from(el.querySelectorAll('.item')).forEach(node => {
		node.addEventListener('click', (e) => {
			// Check if clicked on a station link
			if (e.target.classList.contains('station-link')) {
				e.stopPropagation();
				const url = new URL(e.target.href);
				const crs = url.searchParams.get('station');
				if (crs) {
					e.preventDefault();
					showStation(crs);
				}
				return;
			}
			
			const otn = node.getAttribute('data-otn');
			const date = node.getAttribute('data-date');
			const std = node.getAttribute('data-std');
			showService(otn, date, std);
		});
	});
}

function formatRealTimeCell(scheduled, expected, actual) {
	const sched = formatTime(scheduled);
	const exp = formatTime(expected);
	const act = formatTime(actual);
	if (act) return `<span class="mono">${act}</span> <span class="muted">actual</span>`;
	if (exp && exp !== sched) {
		const schedText = sched ? ` <span class="muted">sched ${sched}</span>` : '';
		return `<span class="mono">${exp}</span> <span class="muted">expected</span>${schedText}`;
	}
	return sched ? `<span class="mono">${sched}</span>` : '—';
}

function renderRealTimeLocation(loc) {
	const label = loc.isOrigin ? 'Origin' : (loc.isDestination ? 'Destination' : 'Calling point');
	const stationHtml = loc.station ? createStationLink(loc.station) : escapeHtml(loc.locationName || loc.tiploc || loc.crs || '(Unknown)');
	const platform = loc.platform || '—';
	let status = '';
	if (loc.isCancelled) {
		status = '<span class="pill pill-danger">Cancelled</span>';
	} else if (loc.isPass) {
		status = '<span class="pill pill-muted">Pass</span>';
	} else if (loc.actualDeparture || loc.actualArrival) {
		status = '<span class="pill pill-success">Completed</span>';
	}
	const alerts = Array.isArray(loc.adhocAlerts) && loc.adhocAlerts.length > 0
		? `<div class="muted" style="font-size:12px; margin-top:6px;">${loc.adhocAlerts.map(escapeHtml).join('<br>')}</div>`
		: '';
	return `<div class="card realtime-card">
		<div class="line-1">
			<span class="otn">${label}</span>
			${status}
		</div>
		<div class="line-2">${stationHtml}</div>
		<div class="kv realtime-kv">
			<div>Arrival</div><div>${formatRealTimeCell(loc.scheduledArrival, loc.expectedArrival, loc.actualArrival)}</div>
			<div>Departure</div><div>${formatRealTimeCell(loc.scheduledDeparture, loc.expectedDeparture, loc.actualDeparture)}</div>
			<div>Platform</div><div>${escapeHtml(platform)}</div>
		</div>
		${alerts}
	</div>`;
}

function renderRealTimeInfo(rt) {
	if (!realtimeSection || !realtimeContent) return;
	if (!rt || !Array.isArray(rt.locations) || rt.locations.length === 0) {
		hideRealTimeSection();
		return;
	}
	realtimeSection.style.display = 'block';
	const updated = rt.generatedAt ? new Date(rt.generatedAt).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
	const metaParts = [];
	if (rt.rid) metaParts.push(`RID ${escapeHtml(rt.rid)}`);
	if (rt.operator) metaParts.push(escapeHtml(rt.operator));
	if (updated) metaParts.push(`Updated ${escapeHtml(updated)}`);
	const summary = metaParts.length > 0
		? `<div class="muted" style="margin-bottom:8px;">${metaParts.join(' • ')}</div>`
		: '';
	realtimeContent.innerHTML = summary + rt.locations.map(renderRealTimeLocation).join('');
	attachStationLinkHandlers(realtimeContent);
}
async function loadService(otn, date, std) {
	const url = `${API_BASE}/api/v1/trains/consist-instance?OperationalTrainNumber=${encodeURIComponent(otn)}&ServiceDate=${encodeURIComponent(date)}&OriginStd=${encodeURIComponent(std)}`;
	const res = await fetch(url);
	if (!res.ok) throw new Error('Service load failed');
	return await res.json();
}

async function loadVehicles(otn, date, std) {
	const url = `${API_BASE}/api/v1/trains/consist-vehicles?OperationalTrainNumber=${encodeURIComponent(otn)}&ServiceDate=${encodeURIComponent(date)}&OriginStd=${encodeURIComponent(std)}`;
	const res = await fetch(url);
	if (!res.ok) throw new Error('Vehicles load failed');
	return await res.json();
}

async function loadServiceRealtime(otn, date, std) {
	const url = `${API_BASE}/api/v1/trains/consist-realtime?OperationalTrainNumber=${encodeURIComponent(otn)}&ServiceDate=${encodeURIComponent(date)}&OriginStd=${encodeURIComponent(std)}`;
	const res = await fetch(url);
	if (res.status === 204) return null;
	if (res.status === 404) return null;
	if (!res.ok) throw new Error('Realtime load failed');
	return await res.json();
}

function renderVehicles(list) {
	const el = document.getElementById('vehicles');
	if (!list || list.length === 0) {
		el.innerHTML = '<div class="muted">No vehicles found.</div>';
		return;
	}
	el.innerHTML = list.map(v => vehicleCardHtml(v, { showResourcePosition: true, linkVehicle: true })).join('');
	Array.from(el.querySelectorAll('.vehicle-link')).forEach(a => {
		a.addEventListener('click', (e) => {
			e.preventDefault();
			const vehId = a.textContent.trim();
			showVehicle(vehId);
		});
	});
}

function renderStationItems(items) {
	if (!items || items.length === 0) {
		sDropdown.style.display = 'none';
		sDropdown.innerHTML = '';
		return;
	}
	sDropdown.innerHTML = items.map(s => {
		const crs = s.threeAlpha || '';
		const name = s.nlcDesc || '';
		return `
			<div class="item" data-crs="${crs}">
				<div class="line-1">
					<span class="otn">${crs}</span>
				</div>
				<div class="line-2">${name}</div>
			</div>`;
	}).join('');
	sDropdown.style.display = 'block';
	Array.from(sDropdown.querySelectorAll('.item')).forEach(el => {
		el.addEventListener('click', () => {
			const crs = el.getAttribute('data-crs');
			showStation(crs);
			sDropdown.style.display = 'none';
		});
	});
}

async function searchStations(qs) {
	if (abortCtrl) abortCtrl.abort();
	abortCtrl = new AbortController();
	const url = `${API_BASE}/api/v1/stations/autocomplete?q=${encodeURIComponent(qs)}&limit=10`;
	try {
		const res = await fetch(url, { signal: abortCtrl.signal });
		if (!res.ok) throw new Error('HTTP ' + res.status);
		const data = await res.json();
		renderStationItems(data);
	} catch (e) {
		if (e.name !== 'AbortError') {
			console.error(e);
			renderStationItems([]);
		}
	}
}

async function loadStationBoard(crs) {
	const url = `${API_BASE}/api/v1/stations/board?crs=${encodeURIComponent(crs)}&numRows=15&timeWindow=120`;
	const res = await fetch(url);
	if (!res.ok) throw new Error('Station board load failed');
	return await res.json();
}

function formatTime(dateStr) {
	if (!dateStr) return '';
	const d = new Date(dateStr);
	return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
}

function renderStationBoard(data) {
	const stationName = document.getElementById('stationName');
	const stationCrs = document.getElementById('stationCrs');
	const stationMessages = document.getElementById('stationMessages');
	const stationServices = document.getElementById('stationServices');
	
	stationName.textContent = data.station.nlcDesc || '';
	stationCrs.textContent = data.station.threeAlpha || '';
	
	// Show NRCC messages if any
	if (data.board.nrccMessages && data.board.nrccMessages.length > 0) {
		stationMessages.style.display = 'block';
		stationMessages.innerHTML = '<h3>Station Information</h3>' + 
			data.board.nrccMessages.map(m => {
				const severity = m.severity || 'Normal';
				const color = severity === 'Severe' ? 'var(--danger)' : 
							  severity === 'Major' ? '#f59e0b' : 
							  'var(--accent)';
				return `<div class="card" style="border-left: 3px solid ${color};">
					<div style="font-weight:600; color:${color}; margin-bottom:4px;">${severity}</div>
					<div style="font-size:14px;">${m.message || ''}</div>
				</div>`;
			}).join('');
	} else {
		stationMessages.style.display = 'none';
	}
	
	// Render services
	if (!data.services || data.services.length === 0) {
		stationServices.innerHTML = '<div class="muted">No services found.</div>';
		return;
	}
	
	stationServices.innerHTML = data.services.map(svc => {
		const trainId = svc.trainId || '';
		const operator = svc.operator || '';
		const platform = svc.platform || 'TBC';
		const platformHidden = svc.platformIsHidden;
		const cancelled = svc.isCancelled;
		
		// Create clickable station links for origins and destinations
		const originLinks = (svc.origin || [])
			.map(o => createStationLink(o))
			.filter(l => l)
			.join(', ');
		const destinationLinks = (svc.destination || [])
			.map(d => createStationLink(d))
			.filter(l => l)
			.join(', ');
		
		const stdTime = formatTime(svc.std);
		const etdTime = formatTime(svc.etd);
		const staTime = formatTime(svc.sta);
		const etaTime = formatTime(svc.eta);
		
		const callingLinks = (svc.subsequentLocations || [])
			.filter(l => !l.isPass) // Exclude pass-through stations
			.map(l => l.station ? createStationLink(l.station) : '')
			.filter(link => link)
			.join(', ');
		const callingText = callingLinks ? `Calling at: ${callingLinks}` : '';
		
		const hasDbData = svc.dbData != null;
		// Use origin STD for database lookup (not the station's STD)
		const serviceDate = svc.sdd ? new Date(svc.sdd).toISOString().split('T')[0] : null;
		const originStd = svc.originStd || null; // Origin departure time for DB lookup
		const clickable = hasDbData && trainId && serviceDate && originStd;
		
		const statusColor = cancelled ? 'var(--danger)' : 'var(--text)';
		const statusText = cancelled ? 'CANCELLED' : 
						  etdTime && etdTime !== stdTime ? `Expected ${etdTime}` :
						  etaTime && etaTime !== staTime ? `Expected ${etaTime}` :
						  'On time';
		
		const platformDisplay = platformHidden ? '—' : platform;
		
		return `<div class="card ${clickable ? 'service-card-clickable' : ''}" 
					${clickable ? `data-otn="${trainId}" data-date="${serviceDate}" data-std="${originStd}"` : ''}>
			<div style="display:flex; justify-content:space-between; align-items:baseline;">
				<div>
					<span style="font-weight:700; font-size:16px;">${stdTime || staTime}</span>
					<span class="muted" style="font-size:13px; margin-left:6px;">${operator}</span>
				</div>
				<div style="display:flex; gap:8px; align-items:center;">
					<span style="font-size:13px; color:${statusColor};">${statusText}</span>
					<span class="pill">Plat ${platformDisplay}</span>
				</div>
			</div>
			<div style="margin-top:6px; font-size:14px;">
				<div><strong>To:</strong> ${destinationLinks}</div>
				${originLinks ? `<div class="muted" style="font-size:13px;">From: ${originLinks}</div>` : ''}
			</div>
			${callingText ? `<div class="muted" style="font-size:13px; margin-top:4px;">${callingText}</div>` : ''}
			${hasDbData ? `<div class="muted" style="font-size:12px; margin-top:6px;">Train ${trainId} ${clickable ? '(click for details)' : ''}</div>` : ''}
		</div>`;
	}).join('');
	
	// Add click handlers for services with DB data
	Array.from(stationServices.querySelectorAll('.service-card-clickable')).forEach(card => {
		card.style.cursor = 'pointer';
		card.addEventListener('click', (e) => {
			// Check if clicked on a station link
			if (e.target.classList.contains('station-link')) {
				e.stopPropagation();
				const url = new URL(e.target.href);
				const crs = url.searchParams.get('station');
				if (crs) {
					e.preventDefault();
					showStation(crs);
				}
				return;
			}
			
			const otn = card.getAttribute('data-otn');
			const date = card.getAttribute('data-date');
			const std = card.getAttribute('data-std');
			if (otn && date && std) {
				showService(otn, date, std);
			}
		});
		card.addEventListener('mouseenter', () => {
			card.style.background = '#0f1a2a';
		});
		card.addEventListener('mouseleave', () => {
			card.style.background = '#0e1520';
		});
	});
}

async function showStation(crs, push = true) {
	searchPanel.style.display = 'none';
	svcPanel.style.display = 'none';
	stationPanel.style.display = 'block';
	sDropdown.style.display = 'none';
	hideRealTimeSection();
	if (push) {
		const qs = `?station=${encodeURIComponent(crs)}`;
		history.pushState({ station: crs }, '', `${qs}`);
	}
	document.getElementById('stationServices').innerHTML = '<div class="muted">Loading live departure board…</div>';
	try {
		const data = await loadStationBoard(crs);
		renderStationBoard(data);
	} catch (e) {
		console.error(e);
		document.getElementById('stationServices').innerHTML = '<div class="muted">Failed to load station board. Please check your National Rail API configuration.</div>';
	}
}

function showSearch(replace = false) {
	svcPanel.style.display = 'none';
	stationPanel.style.display = 'none';
	searchPanel.style.display = 'grid';
	dropdown.style.display = 'none';
	hideWikipediaSection();
	hideRealTimeSection();
	if (replace) {
		history.replaceState({}, '', location.pathname);
	}
}

async function showService(otn, date, std, push = true) {
	searchPanel.style.display = 'none';
	stationPanel.style.display = 'none';
	svcPanel.style.display = 'block';
	dropdown.style.display = 'none';
	hideRealTimeSection();
	if (push) {
		const qs = `?otn=${encodeURIComponent(otn)}&date=${encodeURIComponent(date)}&std=${encodeURIComponent(std)}`;
		history.pushState({ otn, date, std }, '', `${qs}`);
	}
	document.getElementById('vehicles').innerHTML = '<div class="muted">Loading…</div>';
	try {
		const servicePromise = loadService(otn, date, std);
		const vehiclesPromise = loadVehicles(otn, date, std);
		const realtimePromise = loadServiceRealtime(otn, date, std).catch(() => null);

		const [svc, vehicles, realtime] = await Promise.all([servicePromise, vehiclesPromise, realtimePromise]);
		setText('otn', svc.operationalTrainNumber);
		setText('svcdate', svc.serviceDate);
		setText('std', svc.originPlannedDepTime);
		
		// Use clickable station links for origin and destination
		const originEl = document.getElementById('origin');
		const destEl = document.getElementById('dest');
		originEl.innerHTML = createStationLink(svc.origin);
		destEl.innerHTML = createStationLink(svc.destination);
		attachStationLinkHandlers(originEl);
		attachStationLinkHandlers(destEl);
		
		setText('classCode', svc.classCode ? `Class ${svc.classCode}` : '');
		setText('classes', svc.railClasses || '');
		setText('power', svc.powerType || '');
		updateWikipediaPanel(svc.classCode || '');
		renderRealTimeInfo(realtime || null);
		renderVehicles(vehicles);
	} catch (e) {
		console.error(e);
		document.getElementById('vehicles').innerHTML = '<div class="muted">Could not identify the vehicles for this service.</div>';
		hideWikipediaSection();
		hideRealTimeSection();
	}
}

(async function init() {
	q.addEventListener('input', () => {
		const val = q.value.trim();
		if (timer) clearTimeout(timer);
		if (!val) {
			renderItems([]);
			return;
		}
		timer = setTimeout(() => search(val), 180);
	});

	q.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			renderItems([]);
		}
	});
	
	sq.addEventListener('input', () => {
		const val = sq.value.trim();
		if (timer) clearTimeout(timer);
		if (!val) {
			renderStationItems([]);
			return;
		}
		timer = setTimeout(() => searchStations(val), 180);
	});
	sq.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			renderStationItems([]);
		}
	});
	
	vq.addEventListener('input', () => {
		const val = vq.value.trim();
		if (timer) clearTimeout(timer);
		if (!val) {
			renderVehicleItems([]);
			vresult.innerHTML = '';
			return;
		}
		timer = setTimeout(() => searchVehicles(val), 180);
	});
	vq.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			renderVehicleItems([]);
		}
	});

	backBtn.addEventListener('click', (e) => {
		e.preventDefault();
		showSearch(true);
	});
	
	stationBackBtn.addEventListener('click', (e) => {
		e.preventDefault();
		showSearch(true);
	});

	homeLink.addEventListener('click', (e) => {
		e.preventDefault();
		showSearch(true);
	});

	window.addEventListener('popstate', () => {
		const qs = new URLSearchParams(location.search);
		const station = qs.get('station') || '';
		const veh = qs.get('veh') || '';
		const otn = qs.get('otn') || '';
		const date = qs.get('date') || '';
		const std = qs.get('std') || '';
		if (station) {
			showStation(station, /*push*/false);
		} else if (veh) {
			showVehicle(veh, /*push*/false);
		} else if (otn && date && std) {
			showService(otn, date, std, /*push*/false);
		} else {
			showSearch(true);
		}
	});

	// Initial route
	const qs = new URLSearchParams(location.search);
	const station = qs.get('station') || '';
	const veh = qs.get('veh') || '';
	const otn = qs.get('otn') || '';
	const date = qs.get('date') || '';
	const std = qs.get('std') || '';
	if (station) {
		showStation(station, /*push*/false);
	} else if (veh) {
		showVehicle(veh, /*push*/false);
	} else if (otn && date && std) {
		showService(otn, date, std, /*push*/false);
	} else {
		showSearch();
	}
})();
</script>
</body>
</html>


